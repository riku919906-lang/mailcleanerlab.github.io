<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Mail Cleaner Lab â€“ Gmailè‡ªå‹•æ•´ç†ãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --danger: #dc2626;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --radius-lg: 14px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    header {
      background: #0f172a;
      color: #f9fafb;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    header .title {
      font-size: 20px;
      font-weight: 700;
    }

    header .subtitle {
      font-size: 12px;
      color: #9ca3af;
    }

    header .badge {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(96, 165, 250, 0.6);
      color: #dbeafe;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    main {
      max-width: 1120px;
      margin: 24px auto 32px;
      padding: 0 16px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 20px;
    }

    @media (max-width: 880px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px 18px 16px;
      box-shadow:
        0 10px 15px -3px rgba(15, 23, 42, 0.08),
        0 4px 6px -4px rgba(15, 23, 42, 0.06);
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card h2 span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--accent);
    }

    .card p.desc {
      margin: 0 0 12px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .section-label {
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
      margin: 16px 0 4px;
    }

    .preset-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .preset-btn {
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #f9fafb;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      color: #374151;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .preset-btn span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .preset-btn:hover {
      background: var(--accent-soft);
      border-color: #bfdbfe;
    }

    label {
      display: block;
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 2px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      background: #f9fafb;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
      background: #ffffff;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .actions-main {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button.primary,
    button.secondary,
    button.ghost,
    button.danger {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    button.primary {
      background: var(--accent);
      color: #ffffff;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.danger {
      background: var(--danger);
      color: #ffffff;
    }

    button.ghost {
      background: transparent;
      color: #4b5563;
      border: 1px solid var(--border);
    }

    button.primary:hover {
      background: #1d4ed8;
    }

    button.danger:hover {
      background: #b91c1c;
    }

    button.secondary:hover {
      background: #d1d5db;
    }

    button.ghost:hover {
      background: #f3f4f6;
    }

    .pill-select {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .pill-select button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      color: #374151;
    }

    .pill-select button.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .preview-box {
      border-radius: var(--radius-sm);
      border: 1px dashed var(--border);
      background: #f9fafb;
      padding: 10px;
      font-size: 12px;
      min-height: 90px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .preview-label {
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .preview-label span.status {
      font-weight: 500;
      color: #16a34a;
    }

    .log-list {
      max-height: 220px;
      overflow-y: auto;
      margin-top: 6px;
      padding-right: 4px;
    }

    .log-item {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 11px;
      margin-bottom: 6px;
      background: #f9fafb;
    }

    .log-item .log-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
    }

    .log-item .log-kind {
      font-weight: 600;
    }

    .log-item .log-time {
      color: var(--text-sub);
    }

    .log-item .log-query {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    .log-empty {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .ad-box {
      border-radius: var(--radius-sm);
      border: 1px dashed #c4b5fd;
      background: #f5f3ff;
      padding: 10px;
      font-size: 11px;
      color: #4c1d95;
      margin-top: 10px;
    }

    .ad-box strong {
      font-size: 12px;
    }

    footer {
      max-width: 1120px;
      margin: 0 auto 20px;
      padding: 0 16px;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill-warning {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #fef3c7;
      color: #92400e;
      font-size: 11px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Mail Cleaner Lab</div>
      <div class="subtitle">Gmail è‡ªå‹•æ•´ç†ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆï¼‰</div>
    </div>
    <div class="badge">gmail helper</div>
  </header>

  <main>
    <!-- å·¦ï¼šæ¡ä»¶å…¥åŠ› -->
    <section class="card">
      <h2>
        <span class="icon">âœ‰</span>
        Gmailæ•´ç†æ¡ä»¶ã®è¨­å®š
      </h2>
      <p class="desc">
        å‰Šé™¤ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ»æ—¢èª­åŒ–ã—ãŸã„ãƒ¡ãƒ¼ãƒ«ã®æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
        ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‹ã‚‰é¸ã‚“ã§ç´°ã‹ãèª¿æ•´ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
      </p>

      <div class="section-label">ğŸ“Œ ã‚ˆãä½¿ã†ãƒ—ãƒªã‚»ãƒƒãƒˆ</div>
      <div class="preset-group">
        <button type="button" class="preset-btn" data-preset="rakuten">
          <span class="dot"></span>æ¥½å¤©ç³»ãƒ¡ãƒ¼ãƒ«
        </button>
        <button type="button" class="preset-btn" data-preset="amazon">
          <span class="dot"></span>Amazoné€šçŸ¥
        </button>
        <button type="button" class="preset-btn" data-preset="promo">
          <span class="dot"></span>åºƒå‘Š / ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
        </button>
        <button type="button" class="preset-btn" data-preset="newsletter">
          <span class="dot"></span>ãƒ¡ãƒ«ãƒã‚¬å…¨èˆ¬
        </button>
        <button type="button" class="preset-btn" data-preset="old30">
          <span class="dot"></span>30æ—¥ã‚ˆã‚Šå‰ã®ãƒ—ãƒ­ãƒ¢
        </button>
        <button type="button" class="preset-btn" data-preset="spam">
          <span class="dot"></span>è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€
        </button>
      </div>

      <div class="section-label">ğŸ” è©³ç´°æ¡ä»¶ï¼ˆå¿…è¦ãªã¨ã“ã‚ã ã‘å…¥åŠ›ã§OKï¼‰</div>
      <div class="row">
        <div>
          <label for="from">é€ä¿¡å…ƒï¼ˆfrom:ï¼‰</label>
          <input type="text" id="from" placeholder="ä¾‹: news@rakuten.co.jp / @example.com">
        </div>
        <div>
          <label for="subject">ä»¶åã«å«ã¾ã‚Œã‚‹èªï¼ˆsubject:ï¼‰</label>
          <input type="text" id="subject" placeholder="ä¾‹: ãƒ¡ãƒ«ãƒã‚¬, ã‚¯ãƒ¼ãƒãƒ³">
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="has">æœ¬æ–‡ã«å«ã¾ã‚Œã‚‹èª</label>
          <input type="text" id="has" placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š OK">
        </div>
        <div>
          <label for="not">å«ã‚ãŸããªã„èªï¼ˆé™¤å¤–ï¼‰</label>
          <input type="text" id="not" placeholder="é‡è¦ãªã‚‚ã®ã‚’é™¤å¤–ã—ãŸã„æ™‚ãªã©">
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="newer">ã„ã¤ä»¥é™ã®ãƒ¡ãƒ¼ãƒ«</label>
          <input type="text" id="newer" placeholder="ä¾‹: 7d / 2024-01-01">
        </div>
        <div>
          <label for="older">ã„ã¤ä»¥å‰ã®ãƒ¡ãƒ¼ãƒ«</label>
          <input type="text" id="older" placeholder="ä¾‹: 30d / 2023-12-31">
        </div>
      </div>

      <div class="section-label">ğŸ§ª ç”Ÿæˆã•ã‚Œã‚‹ Gmail æ¤œç´¢ã‚¯ã‚¨ãƒª</div>
      <label for="query">å¿…è¦ãªã‚‰ç›´æ¥ç·¨é›†ã‚‚ã§ãã¾ã™</label>
      <textarea id="query" placeholder="ä¾‹: from:@rakuten.co.jp subject:(ãƒã‚¤ãƒ³ãƒˆ) newer_than:30d"></textarea>

      <div class="pill-warning">
        âš  ã“ã®ã‚¯ã‚¨ãƒªã«ãƒãƒƒãƒã—ãŸãƒ¡ãƒ¼ãƒ«ãŒå¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚å®Ÿè¡Œå‰ã«å¿…ãšå†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
      </div>

      <div class="section-label">âš™ å®Ÿè¡Œã—ãŸã„æ“ä½œ</div>
      <div class="pill-select" id="actionPills">
        <button type="button" data-action="trash" class="active">ã‚´ãƒŸç®±ã¸ç§»å‹•ï¼ˆå‰Šé™¤ï¼‰</button>
        <button type="button" data-action="archive">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>
        <button type="button" data-action="read">æ—¢èª­ã«ã™ã‚‹</button>
      </div>

      <div class="actions-main">
        <button type="button" class="secondary" id="btnBuild">
          ğŸ” ã‚¯ã‚¨ãƒªã‚’è‡ªå‹•ç”Ÿæˆ
        </button>
        <button type="button" class="ghost" id="btnPreview">
          ğŸ‘ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæ¡ä»¶ãƒã‚§ãƒƒã‚¯ï¼‰
        </button>
        <button type="button" class="danger" id="btnExecute">
          âš¡ ã“ã®æ¡ä»¶ã§å®Ÿè¡Œ
        </button>
      </div>
    </section>

    <!-- å³ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & ãƒ­ã‚° & åºƒå‘Šã‚¹ãƒšãƒ¼ã‚¹ -->
    <section class="card">
      <h2>
        <span class="icon">ğŸ‘</span>
        å®Ÿè¡Œå†…å®¹ã®ç¢ºèªã¨ãƒ­ã‚°
      </h2>
      <p class="desc">
        å®Ÿè¡Œå‰ã«ã€ã©ã‚“ãªæ¡ä»¶ã§ã©ã®æ“ä½œã‚’è¡Œã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>
        å®Ÿè¡Œå±¥æ­´ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã€å¾Œã‹ã‚‰è¦‹è¿”ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
      </p>

      <div class="preview-label">
        <span>ç¾åœ¨ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
        <span class="status" id="previewStatus">æœªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
      </div>
      <div class="preview-box" id="previewBox">
        ã€Œã‚¯ã‚¨ãƒªã‚’è‡ªå‹•ç”Ÿæˆã€â†’ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã®é †ã«æŠ¼ã™ã¨ã€ã“ã“ã«å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="section-label" style="margin-top:14px;">ğŸ§¾ å®Ÿè¡Œãƒ­ã‚°</div>
      <div class="log-list" id="logList"></div>
      <div class="log-empty" id="logEmpty">
        ã¾ã å®Ÿè¡Œãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«å±¥æ­´ãŒæ®‹ã‚Šã¾ã™ã€‚
      </div>

      <button type="button" class="ghost" id="btnClearLog" style="margin-top:4px;">
        ğŸ§¹ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
      </button>

      <div class="section-label" style="margin-top:14px;">ğŸ’° åç›ŠåŒ–ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆåºƒå‘Šãªã©ï¼‰</div>
      <div class="ad-box" id="adArea">
        <strong>ã‚¹ãƒãƒ³ã‚µãƒ¼æ </strong><br>
        å°†æ¥çš„ã«ã€ã“ã“ã«ãƒãƒŠãƒ¼åºƒå‘Šã‚„æœ‰æ–™ç‰ˆã¸ã®æ¡ˆå†…ãƒªãƒ³ã‚¯ã‚’è¨­ç½®ã§ãã¾ã™ã€‚<br>
        ä¾‹ï¼šGoogle AdSenseã€noteæœ‰æ–™è¨˜äº‹ã€ã‚³ã‚³ãƒŠãƒ©å‡ºå“ãƒšãƒ¼ã‚¸ãªã©ã€‚
      </div>
    </section>
  </main>

  <footer>
    <span>Mail Cleaner Lab â€“ Gmail è‡ªå‹•æ•´ç†ãƒ„ãƒ¼ãƒ«ï¼ˆå€‹äººåˆ©ç”¨å‘ã‘ï¼‰</span>
    <span>â€»GAS ã‚„ Gmail API ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«æ“ä½œãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</span>
  </footer>

  <script>
    // ------------------------------
    // ãƒ—ãƒªã‚»ãƒƒãƒˆå®šç¾©
    // ------------------------------
    const presets = {
      rakuten: {
        label: 'æ¥½å¤©ç³»ãƒ¡ãƒ¼ãƒ«',
        query:
          'from:(@rakuten.co.jp OR @rakuten-card.co.jp OR @rakuten-bank.co.jp)'
      },
      amazon: {
        label: 'Amazoné€šçŸ¥',
        query: 'from:(@amazon.co.jp OR @marketing.amazon.co.jp)'
      },
      promo: {
        label: 'åºƒå‘Š / ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³',
        query: 'category:promotions'
      },
      newsletter: {
        label: 'ãƒ¡ãƒ«ãƒã‚¬å…¨èˆ¬',
        query: 'category:promotions OR "ãƒ¡ãƒ«ãƒã‚¬"'
      },
      old30: {
        label: '30æ—¥ã‚ˆã‚Šå‰ã®ãƒ—ãƒ­ãƒ¢',
        query: 'category:promotions older_than:30d'
      },
      spam: {
        label: 'è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€',
        query: 'in:spam'
      }
    };

    // ------------------------------
    // UI ã®å–å¾—
    // ------------------------------
    const $ = (id) => document.getElementById(id);

    const fromInput = $('from');
    const subjectInput = $('subject');
    const hasInput = $('has');
    const notInput = $('not');
    const newerInput = $('newer');
    const olderInput = $('older');
    const queryInput = $('query');

    const previewBox = $('previewBox');
    const previewStatus = $('previewStatus');
    const logList = $('logList');
    const logEmpty = $('logEmpty');

    const btnBuild = $('btnBuild');
    const btnPreview = $('btnPreview');
    const btnExecute = $('btnExecute');
    const btnClearLog = $('btnClearLog');

    const actionPills = $('actionPills');

    // ------------------------------
    // å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é¸æŠ
    // ------------------------------
    let currentAction = 'trash';

    actionPills.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const action = btn.dataset.action;
      currentAction = action;

      [...actionPills.querySelectorAll('button')].forEach((b) =>
        b.classList.toggle('active', b === btn)
      );
    });

    // ------------------------------
    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯
    // ------------------------------
    document.querySelectorAll('.preset-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const presetKey = btn.dataset.preset;
        const preset = presets[presetKey];
        if (!preset) return;

        // æ—¢å­˜ã®ã‚¯ã‚¨ãƒªã¯ä¸Šæ›¸ãï¼ˆå¿…è¦ãªã‚‰è¿½è¨˜ã§ã‚‚OKï¼‰
        queryInput.value = preset.query;

        // ã©ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‹åˆ†ã‹ã‚‹ã‚ˆã†ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´ã«è¡¨ç¤º
        previewStatus.textContent = `ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨: ${preset.label}`;
        previewStatus.style.color = '#2563eb';
        previewBox.textContent =
          `ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${preset.label}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚\n\n` +
          `ç¾åœ¨ã®ã‚¯ã‚¨ãƒª:\n${preset.query}\n\n` +
          'å¿…è¦ã«å¿œã˜ã¦è©³ç´°æ¡ä»¶ã‚’è¿½åŠ ã—ã¦ã‹ã‚‰ã€Œã‚¯ã‚¨ãƒªã‚’è‡ªå‹•ç”Ÿæˆã€ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
      });
    });

    // ------------------------------
    // ã‚¯ã‚¨ãƒªè‡ªå‹•ç”Ÿæˆ
    // ------------------------------
    function buildQueryFromFields() {
      const parts = [];

      if (fromInput.value.trim()) {
        parts.push(`from:(${fromInput.value.trim()})`);
      }
      if (subjectInput.value.trim()) {
        parts.push(`subject:(${subjectInput.value.trim()})`);
      }
      if (hasInput.value.trim()) {
        parts.push(`"${hasInput.value.trim()}"`);
      }
      if (notInput.value.trim()) {
        parts.push(`-"${notInput.value.trim()}"`);
      }
      if (newerInput.value.trim()) {
        const v = newerInput.value.trim();
        parts.push(
          v.match(/d$/) ? `newer_than:${v}` : `newer:${v}`
        );
      }
      if (olderInput.value.trim()) {
        const v = olderInput.value.trim();
        parts.push(
          v.match(/d$/) ? `older_than:${v}` : `older:${v}`
        );
      }

      // æ—¢ã«ã‚¯ã‚¨ãƒªæ¬„ã«ä½•ã‹æ›¸ã„ã¦ã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚‚å°Šé‡
      const base = queryInput.value.trim();
      const finalQuery = [base, ...parts].filter(Boolean).join(' ');

      queryInput.value = finalQuery;

      previewStatus.textContent = 'ã‚¯ã‚¨ãƒªã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸ';
      previewStatus.style.color = '#16a34a';
      previewBox.textContent =
        'ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚\n\n' +
        finalQuery +
        '\n\nã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã§å®Ÿè¡Œå†…å®¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚';
    }

    btnBuild.addEventListener('click', buildQueryFromFields);

    // ------------------------------
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã“ã“ã§ã¯ã€Œæ¡ä»¶ã®ç¢ºèªã€ï¼‰
    // â€»å®Ÿéš›ã®ä»¶æ•°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã¯ GAS / Gmail API å´ã®å®Ÿè£…ãŒå¿…è¦
    // ------------------------------
    function preview() {
      const q = queryInput.value.trim();
      if (!q) {
        previewStatus.textContent = 'ã‚¯ã‚¨ãƒªãŒç©ºã§ã™';
        previewStatus.style.color = '#dc2626';
        previewBox.textContent =
          'ã‚¯ã‚¨ãƒªãŒç©ºã§ã™ã€‚ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸ã¶ã‹ã€æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ã€Œã‚¯ã‚¨ãƒªã‚’è‡ªå‹•ç”Ÿæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        return;
      }

      const actionLabel =
        currentAction === 'trash'
          ? 'ã‚´ãƒŸç®±ã¸ç§»å‹•ï¼ˆå‰Šé™¤ï¼‰'
          : currentAction === 'archive'
          ? 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'
          : 'æ—¢èª­ã«ã™ã‚‹';

      previewStatus.textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆã¿ï¼ˆã¾ã å®Ÿè¡Œã¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰';
      previewStatus.style.color = '#16a34a';

      previewBox.textContent =
        'ã“ã®æ¡ä»¶ã§ä»¥ä¸‹ã®æ“ä½œã‚’è¡Œã†äºˆå®šã§ã™ã€‚\n\n' +
        `ã€æ“ä½œã€‘${actionLabel}\n\n` +
        'ã€Gmailæ¤œç´¢ã‚¯ã‚¨ãƒªã€‘\n' +
        q +
        '\n\n' +
        'â€»å®Ÿéš›ã«ä½•ä»¶ãƒ’ãƒƒãƒˆã™ã‚‹ã‹ã®ç¢ºèªã‚„ã€ãƒ¡ãƒ¼ãƒ«ä¸€è¦§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã€\n' +
        'ã€€ä»Šå¾Œ GAS ã‚„ Gmail API å´ã§ã®å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚';
    }

    btnPreview.addEventListener('click', preview);

    // ------------------------------
    // å®Ÿè¡Œå‡¦ç†ï¼ˆGAS / Gmail API é€£æºãƒã‚¤ãƒ³ãƒˆï¼‰
    // ------------------------------
    function executeAction() {
      const q = queryInput.value.trim();
      if (!q) {
        alert('ã‚¯ã‚¨ãƒªãŒç©ºã§ã™ã€‚ã¾ãšã¯æ¡ä»¶ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const actionLabel =
        currentAction === 'trash'
          ? 'ã‚´ãƒŸç®±ã¸ç§»å‹•ï¼ˆå‰Šé™¤ï¼‰'
          : currentAction === 'archive'
          ? 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'
          : 'æ—¢èª­ã«ã™ã‚‹';

      const confirmed = confirm(
        `æœ¬å½“ã«ã“ã®æ¡ä»¶ã§ã€Œ${actionLabel}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\n` +
          'ã€Gmailæ¤œç´¢ã‚¯ã‚¨ãƒªã€‘\n' +
          q +
          '\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚'
      );
      if (!confirmed) return;

      // --- ã“ã“ã‹ã‚‰ä¸‹ã‚’ã€ç’°å¢ƒã«åˆã‚ã›ã¦å·®ã—æ›¿ãˆ ---

      // 1) GAS ç‰ˆã®å ´åˆï¼ˆHtmlService å†…ã§å‹•ã‹ã™ã¨ãï¼‰
      //    ãƒ»deleteByQuery, archiveByQuery, markReadByQuery
      //      ãªã©ã®é–¢æ•°ã‚’ GAS å´ã«ç”¨æ„ã—ã¦ãŠãã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
      if (typeof google !== 'undefined' && google.script) {
        const handler = (res) => {
          const msg = res && res.message ? res.message : 'å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
          alert(msg);
          addLogEntry(actionLabel, q, msg);
        };

        let fnName = '';
        if (currentAction === 'trash') fnName = 'deleteByQuery';
        if (currentAction === 'archive') fnName = 'archiveByQuery';
        if (currentAction === 'read') fnName = 'markReadByQuery';

        if (fnName) {
          google.script.run
            .withSuccessHandler(handler)
            .withFailureHandler((err) => {
              const msg = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message;
              alert(msg);
              addLogEntry(actionLabel, q, msg);
            })[fnName](q);
        } else {
          const msg = 'æœªå¯¾å¿œã®æ“ä½œã§ã™ã€‚';
          alert(msg);
          addLogEntry(actionLabel, q, msg);
        }
      } else {
        // 2) GitHub Pages ç‰ˆãªã©ã€ã¾ã ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒãªã„å ´åˆ
        //    ã¨ã‚Šã‚ãˆãšã€Œå®Ÿè¡Œã—ãŸé¢¨ã€ã®ãƒ­ã‚°ã ã‘æ®‹ã™ã€‚
        const msg =
          'ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€å®Ÿéš›ã®Gmailæ“ä½œã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ã€‚\n' +
          'GAS ã¾ãŸã¯ Gmail API ã‚’é€£æºã™ã‚‹ã¨æœ¬å½“ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚';
        alert(msg);
        addLogEntry(actionLabel, q, msg);
      }
    }

    btnExecute.addEventListener('click', executeAction);

    // ------------------------------
    // ãƒ­ã‚°ä¿å­˜ï¼ˆlocalStorageï¼‰
    // ------------------------------
    const LOG_KEY = 'mailCleanerLab_logs_v1';

    function loadLogs() {
      try {
        const raw = localStorage.getItem(LOG_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveLogs(logs) {
      try {
        localStorage.setItem(LOG_KEY, JSON.stringify(logs));
      } catch {
        // ignore
      }
    }

    function renderLogs() {
      const logs = loadLogs();
      logList.innerHTML = '';

      if (!logs.length) {
        logEmpty.style.display = 'block';
        return;
      }

      logEmpty.style.display = 'none';

      logs
        .slice()
        .reverse()
        .forEach((log) => {
          const div = document.createElement('div');
          div.className = 'log-item';
          div.innerHTML = `
            <div class="log-header">
              <div class="log-kind">ã€${log.action}ã€‘</div>
              <div class="log-time">${log.time}</div>
            </div>
            <div class="log-query">${log.query}</div>
            <div style="margin-top:2px;">${log.message}</div>
          `;
          logList.appendChild(div);
        });
    }

    function addLogEntry(actionLabel, query, message) {
      const logs = loadLogs();
      logs.push({
        action: actionLabel,
        query,
        message,
        time: new Date().toLocaleString('ja-JP')
      });
      saveLogs(logs);
      renderLogs();
    }

    btnClearLog.addEventListener('click', () => {
      if (!confirm('ãƒ­ã‚°ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      localStorage.removeItem(LOG_KEY);
      renderLogs();
    });

    // åˆæœŸæç”»
    renderLogs();
  </script>
</body>
</html>
